{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": "container",
    "height": "container",
    "title": "Top 5 busiest neighborhoods per hour",

    "background": "rgba(0, 0, 0, 0)",

    "view": {
        "stroke": "transparent"
    },

    "config": {
        "font": "text-medium",
        "title": {
            "font": "text-medium",
            "fontSize": 14.6666
        }
    },

    "params": [{
            "name": "time_of_day",
            "value": 9,
            "bind": {
                "element": "#time_of_day_external_input"
            }
        },

        {
            "name": "selected_borough",
            "value": "All",
            "bind": {
                "element": "#selected_borough_external_input"
            }
        }
    ],

    "data": {
        "name": "all-pickups",
        "url": "https://eshjordan.github.io/fit3179-assignment2/data/all-neighborhoods-data-apr14-new.csv",
        "format": {
            "type": "csv"
        }
    },

    "transform": [{
            "lookup": "u_neighborhood",
            "from": {
                "data": {
                    "name": "lookup-data",
                    "url": "https://eshjordan.github.io/fit3179-assignment2/data/neighborhood-lookup.csv",
                    "format": {
                        "type": "csv"
                    }
                },
                "key": "l_neighborhood",
                "fields": ["l_borough", "l_pop_2010"]
            }
        },

        {
            "filter": "datum.l_borough == selected_borough || selected_borough == 'All'"
        },

        {
            "joinaggregate": [{
                "op": "sum",
                "field": "l_pop_2010",
                "as": "borough_population"
            }],
            "groupby": [
                "l_borough"
            ]
        },

        {
            "calculate": "datum['u_hr_' + time_of_day]",
            "as": "hour_count"
        },

        {
            "joinaggregate": [{
                "op": "sum",
                "field": "hour_count",
                "as": "num_pickups_by_neighborhood"
            }],
            "groupby": [
                "u_neighborhood"
            ]
        },

        {
            "calculate": "parseInt((datum.u_neighborhood == 'John F. Kennedy International Airport' || datum.u_neighborhood == 'Great Kills Park' || datum.u_neighborhood == 'Ellis Island' || datum.u_neighborhood == 'Hoffman Island' || datum.u_neighborhood == 'Jamaica Bay' || datum.u_neighborhood == 'LaGuardia Airport' || datum.u_neighborhood == 'Pelham Islands' || datum.u_neighborhood == 'Port Ivory') ? datum.num_pickups_by_neighborhood : (datum.num_pickups_by_neighborhood / (datum.l_pop_2010/100000)))",
            "as": "norm_pickups_by_neighborhood"
        },

        {
            "window": [{
                "op": "rank",
                "as": "rank"
            }],
            "sort": [
                { "field": "norm_pickups_by_neighborhood", "order": "descending" },
                { "field": "num_pickups_by_neighborhood", "order": "descending" },
                { "field": "l_pop_2010", "order": "descending" }
            ]
        },

        {
            "filter": "parseInt(datum.rank) <= 5 && datum.norm_pickups_by_neighborhood > 0"
        }
    ],

    "mark": "bar",

    "encoding": {
        "x": {
            "field": "u_neighborhood",
            "type": "nominal",
            "title": "",
            "axis": {
                "grid": false
            },
            "sort": "-y"
        },

        "y": {
            "field": "norm_pickups_by_neighborhood",
            "type": "quantitative",
            "stack": "zero",
            "title": "Number of trips per 100,000 people",
            "axis": {
                "grid": false
            },
            "scale": {
                "domain": [
                    0,
                    {
                        "expr": "(selected_borough == 'All' || selected_borough == 'Manhattan') ? 40000 : (selected_borough == 'Bronx' ? 1000 : (selected_borough == 'Brooklyn' ? 9000 : (selected_borough == 'Staten Island' ? 20 : 18000)))"
                    }
                ]
            }
        },

        "color": {
            "field": "u_neighborhood",
            "type": "nominal",
            "title": "Neighborhood"
        },

        "tooltip": [{
                "title": "Neighborhood",
                "field": "u_neighborhood"
            },

            {
                "title": "Borough",
                "field": "l_borough"
            },

            {
                "title": "Trips per 100,000 people",
                "field": "norm_pickups_by_neighborhood",
                "format": ",.2f"
            }
        ]
    }
}